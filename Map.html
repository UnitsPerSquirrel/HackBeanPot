<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100% }
    </style>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.11.0.min.js"> </script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBspUEDd0uX8Il_1rp3Jri5bju2THqfezE&sensor=false"></script>
    <script type="text/javascript">
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(success, noDefault);
        } else {
            noDefault();
        }
        var map;
				var found = false;
        function success(position) {
            var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
            var mapOptions = {
              center: latlng,
              zoom: 15
            };
            map = new google.maps.Map(document.getElementById("map-canvas"),
                mapOptions);
            google.maps.event.addListener(map, 'tilesloaded', function() {
                getCountry(map.getBounds());
            });
            google.maps.event.addListener(map, 'dragend', function() { found = false;});
        };
        function noDefault(error) {
            var mapOptions = {
                  center: new google.maps.LatLng(0,0),
                  zoom: 2
                };
            map = new google.maps.Map(document.getElementById("map-canvas"),
                mapOptions);
            
        };
        // alert country based on latlong
      	function getCountry(bounds) {
						var NE = bounds.getNorthEast();
						var SW = bounds.getSouthWest();
            var geocoder = new google.maps.Geocoder();
						var minLat = NE.lat() < SW.lat() ? NE.lat() : SW.lat();
						var minLng = NE.lng() < SW.lng() ? NE.lng() : SW.lng();
						var latDist = NE.lat() - SW.lat();
						var lngDist = NE.lng() - SW.lng();
						latDist = Math.max(latDist, -1*latDist);
						lngDist = Math.max(lngDist, -1*lngDist);
						var latlong;
						for(var i = 0; i <= 9; i++) {
							for(var j = 0; j <= 9; j++) {
								latlong = new google.maps.LatLng(minLat+(i/9.0)*latDist, minLng+(j/9.0)*lngDist, true);
		            geocoder.geocode({'latLng': latlong}, function(results, status) {
	           	    if (status == google.maps.GeocoderStatus.OK) {
	           	    	if (results[1]) {
											found = true;
    	                updateStories((results[1].formatted_address).match(/[\w\s]+$/)[0]);
											//throw new Error(latlong.lat() + ', ' + latlong.lng() + ', ' + results[1].formatted_address);
    	  	 	        }
										else {
											//alert('No result');
										}	
    	       	    }
									else {
										//alert('Status error');
									}							
	      	      });
							}
						}
						if(!found) {
							updateStories('World');
						}
						else {
							//window.setTimeout(function(){found = false;}, 8000); // fix this
						}        
       }
      // google.maps.event.addDomListener(window, 'load', initialize);
      function updateStories(place){
					//alert(place);
          // given a place, display (up to) 10 NPR stories with it
          $.ajax({
             url:"http://api.npr.org/query?apiKey=MDEzMTU2NjM5MDEzOTE4MzE1MjA5YjY1YQ001&searchType=mainText&output=JSON&searchTerm="+place,
             dataType: 'jsonp', 
             success:function(data){
                 // do stuff with json (in this case an array)
                 $("#news").text("No stories found for "+place+". Please change map position and try again.");
                 $.each(data['list']['story'], function (i, item) {
                    title = item['title']['$text']; // get the text
                    url = item['link'][0]['$text'];
                    miniTeaser = item['miniTeaser'] && item['miniTeaser']['$text'] ? item['miniTeaser']['$text'] : "";
                    if (miniTeaser == "") {
                        miniTeaser = item['teaser']['$text'];
                    }
                    if (i == 0) {
                        $("#news").empty();
												$("#news").text("Location: " + place);
                    }
                    $("#news").append("<li><a href='"+url+"'>"+title+"</a><br/>"+miniTeaser+"</li>");                
                 });          
                 
             },
             error:function(){
                 alert("Could not contact NPR API");
             }
        });
    }
    
    
    </script>
    
  </head>
  <body>
    <div style="float:left; width:30%; overflow-y:scroll; height:100%">
    <ul id ="news">
    </ul>
    </div>
    <div style="float:right; width:70%" id="map-canvas"/>
  </body>
</html>
